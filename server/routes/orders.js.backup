const express = require('express');
const router = express.Router();
const db = require('../models/database');
const { v4: uuidv4 } = require('uuid');
const jwt = require('jsonwebtoken');

const JWT_SECRET = process.env.JWT_SECRET || 'kudimall_buyer_secret_key_2024';

// Calculate delivery fee based on location
const calculateDeliveryFee = (address) => {
  if (!address) return 0;
  
  const addressLower = address.toLowerCase();
  
  // Major cities - Free delivery
  const majorCities = ['accra', 'kumasi', 'tema', 'takoradi', 'cape coast', 'tamale'];
  if (majorCities.some(city => addressLower.includes(city))) {
    return 0;
  }
  
  // Regional capitals - ‚Çµ10 delivery
  const regionalCapitals = [
    'sunyani', 'koforidua', 'ho', 'wa', 'bolgatanga', 
    'sekondi', 'obuasi', 'tarkwa', 'techiman'
  ];
  if (regionalCapitals.some(city => addressLower.includes(city))) {
    return 10;
  }
  
  // Remote areas - ‚Çµ20 delivery
  return 20;
};

// Optional buyer authentication middleware
const optionalBuyerAuth = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (token) {
    jwt.verify(token, JWT_SECRET, (err, buyer) => {
      if (!err) {
        req.buyer = buyer;
      }
    });
  }
  next();
};

// Create order (checkout)
router.post('/', optionalBuyerAuth, async (req, res) => {
  try {
    const {
      buyer_name,
      buyer_email,
      buyer_phone,
      seller_id,
      product_id,
      quantity,
      delivery_address
    } = req.body;
    
    console.log('üì¶ Creating order:', {
      buyer_name,
      buyer_email,
      seller_id,
      product_id,
      quantity,
      has_delivery_address: !!delivery_address
    });
    
    if (!buyer_name || !buyer_email || !buyer_phone || !seller_id || 
        !product_id || !quantity || !delivery_address) {
      console.error('‚ùå Missing required fields:', req.body);
      return res.status(400).json({ error: 'Missing required fields' });
    }
    
    // Get product details
    const product = await db.get(
      'SELECT * FROM products WHERE id = $1',
      [product_id]
    );
    
    if (!product) {
      return res.status(404).json({ error: 'Product not found' });
    }
    
    if (product.stock < quantity) {
      return res.status(400).json({ error: 'Insufficient stock' });
    }
    
    const subtotal = product.price * quantity;
    const order_number = `KM-${uuidv4().slice(0, 8).toUpperCase()}`;
    
    // Get buyer_id if logged in
    const buyer_id = req.buyer ? req.buyer.id : null;
    
    // Calculate delivery fee based on city/address
    const deliveryFee = calculateDeliveryFee(delivery_address);
    const total = subtotal + deliveryFee;
    const total_amount = total;
    
    console.log('üí≥ Order total calculation:', {
      subtotal,
      deliveryFee,
      total,
      total_amount
    });
    
    // Create order
    const orderResult = await db.run(
      `INSERT INTO orders (
        order_number, buyer_id, buyer_name, buyer_email, buyer_phone,
        seller_id, product_id, quantity, unit_price,
        subtotal, delivery_fee, total_amount, delivery_address,
        order_status, payment_status
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15)
      RETURNING id, order_number, total_amount, created_at`,
      [
        order_number, buyer_id, buyer_name, buyer_email, buyer_phone,
        seller_id, product_id, quantity, product.price,
        subtotal, deliveryFee, total_amount, delivery_address,
        'pending', 'pending'
      ]
    );
    
    console.log('‚úÖ Order created:', orderResult.rows[0]);
    
    // Update product stock
    await db.run(
      'UPDATE products SET stock = stock - $1 WHERE id = $2',
      [quantity, product_id]
    );
    
    // Return order details
    res.status(201).json({
      order_id: orderResult.rows[0].id,
      order_number: orderResult.rows[0].order_number,
      total_amount: orderResult.rows[0].total_amount,
      created_at: orderResult.rows[0].created_at,
      message: 'Order placed successfully'
    });